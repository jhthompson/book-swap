{% load static %}

<!DOCTYPE html>
<html>
<head>
    <title>Book Listings Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100vh;
            width: 100vw;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
const map = L.map('map', { maxZoom: 13 }).setView([56.1304, -106.3468], 4); // Centered on Canada

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
}).addTo(map);

const markers = L.markerClusterGroup();
map.addLayer(markers);

function fetchListings() {
    const bounds = map.getBounds();
    const params = new URLSearchParams({
        north: bounds.getNorth(),
        south: bounds.getSouth(),
        east: bounds.getEast(),
        west: bounds.getWest(),
        zoom: map.getZoom(),
    });
    fetch(`/api/book-listings/?${params}`)
        .then(res => res.json())
        .then(data => {
            markers.clearLayers();
            data.results.forEach(listing => {
                const coverIcon = L.icon({
                    iconUrl: listing.cover,
                    iconSize:     [40, 60],
                    popupAnchor:  [0, -30]
                });
                const marker = L.marker([listing.location.lat, listing.location.lng], { icon: coverIcon });
                marker.bindPopup(`<b>${listing.title}</b><br>${listing.author}<br><a href="/swaps/new?proposed_to=${ listing.owner.id }&requested_book_listing_ids=${ listing.id }">Propose Swap</a>`);
                markers.addLayer(marker);
            });
        });
}

map.on('moveend', fetchListings);
fetchListings();
</script>
</body>
</html>